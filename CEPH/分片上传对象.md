

分片上传对象的attr保存在哪里？每个对象都保存一份还是只保存一份？

> 应该是每次put对象时保存的。

---

## 清理分片对象上传垃圾

```shell
while true
do
  rm -f more-to-come
  radosgw-admin bucket list --bucket=pcg-docker |
  grep '"name": "_multipart' |
  awk -F '"' '{print $4}' |
  sed -e 's/^_multipart_//' -e 's/\.meta$//' -e 's/.2~/ 2~/' -e 's/\.[0-9]*$//' |
  sort |
  uniq |
  while read OBJ UPLOADID
  do
    echo "Checking" "s3://pcg-docker/$OBJ" "$UPLOADID"
    if s3cmd listmp "s3://pcg-docker/$OBJ" "$UPLOADID" > /dev/null
    then
      s3cmd abortmp "s3://pcg-docker/$OBJ" "$UPLOADID"
      touch more-to-come
    fi
  done
  if ! [ -f more-to-come ]
  then
    break
  fi
done | tee -a abort-orphan.txt
```



```shell
rgw_process_authenticated
RGWInitMultipart::execute
RGWRados::Object::Write::write_meta
RGWRados::Object::Write::_do_write_meta
RGWRados::Bucket::UpdateIndex::prepare
RGWRados::Bucket::UpdateIndex::guard_reshard
RGWRados::Bucket::UpdateIndex::get_bucket_shard 
RGWRados::Bucket::UpdateIndex::init_bs
RGWRados::BucketShard::init
RGWRados::get_bucket_instance_info
RGWRados::get_bucket_instance_from_oid
```

