



---

## 清理分片对象上传垃圾

```shell
while true
do
  rm -f more-to-come
  radosgw-admin bucket list --bucket=pcg-docker |
  grep '"name": "_multipart' |
  awk -F '"' '{print $4}' |
  sed -e 's/^_multipart_//' -e 's/\.meta$//' -e 's/.2~/ 2~/' -e 's/\.[0-9]*$//' |
  sort |
  uniq |
  while read OBJ UPLOADID
  do
    echo "Checking" "s3://pcg-docker/$OBJ" "$UPLOADID"
    if s3cmd listmp "s3://pcg-docker/$OBJ" "$UPLOADID" > /dev/null
    then
      s3cmd abortmp "s3://pcg-docker/$OBJ" "$UPLOADID"
      touch more-to-come
    fi
  done
  if ! [ -f more-to-come ]
  then
    break
  fi
done | tee -a abort-orphan.txt
```

