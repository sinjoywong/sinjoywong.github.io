

分片上传对象的attr保存在哪里？每个对象都保存一份还是只保存一份？

> 应该是每次put对象时保存的。



### 分段上传

RGW中的应用对象对应RADOS对象。应用对象上传分整体上传和分段上传，不同的上传方式应用对象对应RADOS对象的方式不同。
首先介绍三个概念：

- rgw_max_chunk_size：分块大小，RGW下发至RADOS集群的单个IO的大小。
- rgw_obj_stripe_size：条带大小，multipart除首对象外的分段其他大小
- class RGWObjManifest：管理应用对象和RADOS对象的对应关系



RGW依照条带大小将应用对象的每一个分段分成多个RADOS对象，每个分段的第一个 RADOS 对象名称为：

- “*multipart*” + “用户上传对象名称” + “分段上传ID” + “分段编号”

其余对象的名称为：

- “*shadow*” + “用户上传对象名称” + “分段上传ID” + “分段编号” +  “_” + “条带编号”

当所有的分段上传结束后，RGW 会从 data_extra_pool 中的分段上传临时对象中读取各个分段信息，主要是各分段的 manifest 信息，组成一个 manifest；==然后生成一个新的 RADOS 对象，即 head obj，用来保存分段上传的应用对象的元数据信息和各分段的manifest。==

对于一个大的RGW Object，会被切割成多个独立的RGW Object上传，称为multipart。multipar的优势是断点续传。s3接口默认切割大小为15MB。

- head: {bucket_id}_{object_name}，只在xattr中存元数据，并不实际包含object data；
- multipart: multipart分段首对象，{bucket_id}__multipart_{prefix}.{multipart_id}，其中`multipart_id`根据`manifest`计算；
- shadow: 从属于multipart的分段对象，{bucket_id}__shadow_{prefix}.{multipart_id}_{shadow_id}，`shadow_id`：根据`manifest.rule.part_size`及 `manifest.rule.stripe_max_size`计算。

以上传10MB为例:

```shell
[root@k8s build]# ./bin/rados ls -p default.rgw.buckets.data

097280ac-668e-4a23-a000-e0da1a3f5db8.4149.1__shadow_TESTFILE_10MB.bmp.2~nWqoE6c4ONwq1B76_HlcU1UmQZyGXD2.1_2
097280ac-668e-4a23-a000-e0da1a3f5db8.4149.1__shadow_TESTFILE_10MB.bmp.2~nWqoE6c4ONwq1B76_HlcU1UmQZyGXD2.1_1
097280ac-668e-4a23-a000-e0da1a3f5db8.4149.1__multipart_TESTFILE_10MB.bmp.2~nWqoE6c4ONwq1B76_HlcU1UmQZyGXD2.1
097280ac-668e-4a23-a000-e0da1a3f5db8.4149.1_TESTFILE_10MB.bmp
```

<img src="http://img.5iqiqu.com/images2/82/82064a716663c15d5f805b74b05c9c3d.png" alt="img" style="zoom:33%;" />



---

## 分片上传对象代码流程

### init-multipart

```shell
rgw_process_authenticated
RGWInitMultipart::execute
RGWRados::Object::Write::write_meta
RGWRados::Object::Write::_do_write_meta
RGWRados::Bucket::UpdateIndex::prepare
RGWRados::Bucket::UpdateIndex::guard_reshard
RGWRados::Bucket::UpdateIndex::get_bucket_shard 
RGWRados::Bucket::UpdateIndex::init_bs
RGWRados::BucketShard::init
RGWRados::get_bucket_instance_info
RGWRados::get_bucket_instance_from_oid
```

### upload part

```shell
rgw_process_authenticated
RGWPutObj::execute
rgw::putobj::MultipartObjectProcessor::prepare
rgw::putobj::MultipartObjectProcessor::prepare_head
RGWObjManifest::generator::create_begin

...
rgw::putobj::MultipartObjectProcessor::complete
RGWRados::Object::Write::write_meta
RGWRados::Object::Write::_do_write_meta
	|--> req_state* s =  get_req_state(); #此时包含generic_attrs，["user.rgw.content_type"] = "image/bmp"
	

```

### complete multipart

```shell


```



## 在ceph中实验

![img](https://blog.kakaocdn.net/dn/bJLnxW/btqY8HPGOv5/VA42tSjoxRNEzhz5iKvVPk/img.png)



![image-20210725000924427](.%E5%88%86%E7%89%87%E4%B8%8A%E4%BC%A0%E5%AF%B9%E8%B1%A1.assets/image-20210725000924427.png)

![Ceph RGW Multipart 流程图](.%E5%88%86%E7%89%87%E4%B8%8A%E4%BC%A0%E5%AF%B9%E8%B1%A1.assets/2016-07-11-ceph-rgw-multipart.png)

```shell
[root@k8s build]# ./bin/rados lspools
.rgw.root
default.rgw.control
default.rgw.meta
default.rgw.log
default.rgw.buckets.index
default.rgw.buckets.non-ec
default.rgw.buckets.data

[root@k8s build]# ./bin/rados ls -p default.rgw.buckets.data
a197db5d-4fa9-464b-a43d-4bb52c563136.4149.1__shadow_FILE_20MB.bmp.2~V_XMc7gSVy5ZAELi4u2aBCcNPR83L1d.1_1
a197db5d-4fa9-464b-a43d-4bb52c563136.4149.1__multipart_FILE_20MB.bmp.2~V_XMc7gSVy5ZAELi4u2aBCcNPR83L1d.1
a197db5d-4fa9-464b-a43d-4bb52c563136.4149.1_FILE_20MB.bmp
a197db5d-4fa9-464b-a43d-4bb52c563136.4149.1__shadow_FILE_20MB.bmp.2~V_XMc7gSVy5ZAELi4u2aBCcNPR83L1d.2_1
a197db5d-4fa9-464b-a43d-4bb52c563136.4149.1__multipart_FILE_20MB.bmp.2~V_XMc7gSVy5ZAELi4u2aBCcNPR83L1d.2
a197db5d-4fa9-464b-a43d-4bb52c563136.4149.1__multipart_FILE_20MB.bmp.2~V_XMc7gSVy5ZAELi4u2aBCcNPR83L1d.3

#查看分片对象信息（大小）
[root@k8s build]# ./bin/rados -p default.rgw.buckets.data stat a197db5d-4fa9-464b-a43d-4bb52c563136.4149.1_FILE_20MB.bmp
default.rgw.buckets.data/a197db5d-4fa9-464b-a43d-4bb52c563136.4149.1_FILE_20MB.bmp mtime 2021-07-24 23:59:25.000000, size 0

#查找header存储信息（pg和osd）
[root@k8s build]# ./bin/ceph osd map default.rgw.buckets.data a197db5d-4fa9-464b-a43d-4bb52c563136.4149.1_FILE_20MB.bmp
osdmap e20 pool 'default.rgw.buckets.data' (7) object 'a197db5d-4fa9-464b-a43d-4bb52c563136.4149.1_FILE_20MB.bmp' -> pg 7.82259daa (7.a) -> up ([0], p0) acting ([0], p0)

#查找osd.0对应的主机信息
[root@k8s build]# ./bin/ceph osd find 0
{
    "osd": 0,
    "addrs": {
        "addrvec": [
            {
                "type": "v2",
                "addr": "10.206.0.2:6802",
                "nonce": 1098052
            },
            {
                "type": "v1",
                "addr": "10.206.0.2:6803",
                "nonce": 1098052
            }
        ]
    },
    "osd_fsid": "f04fdb21-da21-42b9-b64a-285ae7def525",
    "host": "k8s",
    "crush_location": {
        "host": "k8s",
        "root": "default"
    }
}

#解析对象的attr:
[root@k8s build]# ./bin/rados getxattr a197db5d-4fa9-464b-a43d-4bb52c563136.4149.1_FILE_20MB.bmp -p default.rgw.buckets.data user.rgw.acl > user.rgw.acl.out

[root@k8s build]# ./bin/ceph-dencoder type RGWAccessControlPolicy import user.rgw.acl.out decode dump_json
{
    "acl": {
        "acl_user_map": [
            {
                "user": "testid",
                "acl": 15
            }
        ],
        "acl_group_map": [],
        "grant_map": [
            {
                "id": "testid",
                "grant": {
                    "type": {
                        "type": 0
                    },
                    "id": "testid",
                    "email": "",
                    "permission": {
                        "flags": 15
                    },
                    "name": "M. Tester",
                    "group": 0,
                    "url_spec": ""
                }
            }
        ]
    },
    "owner": {
        "id": "testid",
        "display_name": "M. Tester"
    }
}

```





```shell
# 查找bucket marker id（object info包含prefix，manifest，rules等）
[root@k8s build]# ./bin/radosgw-admin object stat --bucket bucket0 --object=FILE_20MB.bmp

{
    "name": "FILE_20MB.bmp",
    "size": 20971520,
    "policy": {
        "acl": {
            "acl_user_map": [
                {
                    "user": "testid",
                    "acl": 15
                }
            ],
            "acl_group_map": [],
            "grant_map": [
                {
                    "id": "testid",
                    "grant": {
                        "type": {
                            "type": 0
                        },
                        "id": "testid",
                        "email": "",
                        "permission": {
                            "flags": 15
                        },
                        "name": "M. Tester",
                        "group": 0,
                        "url_spec": ""
                    }
                }
            ]
        },
        "owner": {
            "id": "testid",
            "display_name": "M. Tester"
        }
    },
    "etag": "5452e5568d20a60209babc69a7b95911-3",
    "tag": "a197db5d-4fa9-464b-a43d-4bb52c563136.4147.6",
    "manifest": {
        "objs": [],
        "obj_size": 20971520,
        "explicit_objs": "false",
        "head_size": 0,
        "max_head_size": 0,
        "prefix": "FILE_20MB.bmp.2~V_XMc7gSVy5ZAELi4u2aBCcNPR83L1d",
        "rules": [
            {
                "key": 0,
                "val": {
                    "start_part_num": 1,
                    "start_ofs": 0,
                    "part_size": 8388608,
                    "stripe_max_size": 4194304,
                    "override_prefix": ""
                }
            },
            {
                "key": 16777216,
                "val": {
                    "start_part_num": 3,
                    "start_ofs": 16777216,
                    "part_size": 4194304,
                    "stripe_max_size": 4194304,
                    "override_prefix": ""
                }
            }
        ],
        "tail_instance": "",
        "tail_placement": {
            "bucket": {
                "name": "bucket0",
                "marker": "a197db5d-4fa9-464b-a43d-4bb52c563136.4149.1",
                "bucket_id": "a197db5d-4fa9-464b-a43d-4bb52c563136.4149.1",
                "tenant": "",
                "explicit_placement": {
                    "data_pool": "",
                    "data_extra_pool": "",
                    "index_pool": ""
                }
            },
            "placement_rule": "default-placement"
        },
        "begin_iter": {
            "part_ofs": 0,
            "stripe_ofs": 0,
            "ofs": 0,
            "stripe_size": 4194304,
            "cur_part_id": 1,
            "cur_stripe": 0,
            "cur_override_prefix": "",
            "location": {
                "placement_rule": "default-placement",
                "obj": {
                    "bucket": {
                        "name": "bucket0",
                        "marker": "a197db5d-4fa9-464b-a43d-4bb52c563136.4149.1",
                        "bucket_id": "a197db5d-4fa9-464b-a43d-4bb52c563136.4149.1",
                        "tenant": "",
                        "explicit_placement": {
                            "data_pool": "",
                            "data_extra_pool": "",
                            "index_pool": ""
                        }
                    },
                    "key": {
                        "name": "FILE_20MB.bmp.2~V_XMc7gSVy5ZAELi4u2aBCcNPR83L1d.1",
                        "instance": "",
                        "ns": "multipart"
                    }
                },
                "raw_obj": {
                    "pool": "",
                    "oid": "",
                    "loc": ""
                },
                "is_raw": false
            }
        },
        "end_iter": {
            "part_ofs": 20971520,
            "stripe_ofs": 20971520,
            "ofs": 20971520,
            "stripe_size": 4194304,
            "cur_part_id": 4,
            "cur_stripe": 0,
            "cur_override_prefix": "",
            "location": {
                "placement_rule": "default-placement",
                "obj": {
                    "bucket": {
                        "name": "bucket0",
                        "marker": "a197db5d-4fa9-464b-a43d-4bb52c563136.4149.1",
                        "bucket_id": "a197db5d-4fa9-464b-a43d-4bb52c563136.4149.1",
                        "tenant": "",
                        "explicit_placement": {
                            "data_pool": "",
                            "data_extra_pool": "",
                            "index_pool": ""
                        }
                    },
                    "key": {
                        "name": "FILE_20MB.bmp.2~V_XMc7gSVy5ZAELi4u2aBCcNPR83L1d.4",
                        "instance": "",
                        "ns": "multipart"
                    }
                },
                "raw_obj": {
                    "pool": "",
                    "oid": "",
                    "loc": ""
                },
                "is_raw": false
            }
        }
    },
    "attrs": {
        "user.rgw.content_type": "image/bmp",
        "user.rgw.pg_ver": "",
        "user.rgw.source_zone": "",
        "user.rgw.tail_tag": "a197db5d-4fa9-464b-a43d-4bb52c563136.4147.6",
        "user.rgw.x-amz-content-sha256": "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
        "user.rgw.x-amz-date": "20210724T155921Z"
    }
}
```



- 



```shell



[root@k8s build]# ./bin/radosgw-admin object stat --bucket bucket0 --object TESTFILE_10MB.bmp
{
    "name": "TESTFILE_10MB.bmp",
    "size": 9684967,
    "policy": {
        "acl": {
            "acl_user_map": [
                {
                    "user": "testid",
                    "acl": 15
                }
            ],
            "acl_group_map": [],
            "grant_map": [
                {
                    "id": "testid",
                    "grant": {
                        "type": {
                            "type": 0
                        },
                        "id": "testid",
                        "email": "",
                        "permission": {
                            "flags": 15
                        },
                        "name": "M. Tester",
                        "group": 0,
                        "url_spec": ""
                    }
                }
            ]
        },
        "owner": {
            "id": "testid",
            "display_name": "M. Tester"
        }
    },
    "etag": "b0e8646234deadafaacafb24b64891c6-1",
    "tag": "097280ac-668e-4a23-a000-e0da1a3f5db8.4147.8",
    "manifest": {
        "objs": [],
        "obj_size": 9684967,
        "explicit_objs": "false",
        "head_size": 0,
        "max_head_size": 0,
        "prefix": "TESTFILE_10MB.bmp.2~nWqoE6c4ONwq1B76_HlcU1UmQZyGXD2",
        "rules": [
            {
                "key": 0,
                "val": {
                    "start_part_num": 1,
                    "start_ofs": 0,
                    "part_size": 0,
                    "stripe_max_size": 4194304,
                    "override_prefix": ""
                }
            }
        ],
        "tail_instance": "",
        "tail_placement": {
            "bucket": {
                "name": "bucket0",
                "marker": "097280ac-668e-4a23-a000-e0da1a3f5db8.4149.1",
                "bucket_id": "097280ac-668e-4a23-a000-e0da1a3f5db8.4149.1",
                "tenant": "",
                "explicit_placement": {
                    "data_pool": "",
                    "data_extra_pool": "",
                    "index_pool": ""
                }
            },
            "placement_rule": "default-placement"
        },
        "begin_iter": {
            "part_ofs": 0,
            "stripe_ofs": 0,
            "ofs": 0,
            "stripe_size": 4194304,
            "cur_part_id": 1,
            "cur_stripe": 0,
            "cur_override_prefix": "",
            "location": {
                "placement_rule": "default-placement",
                "obj": {
                    "bucket": {
                        "name": "bucket0",
                        "marker": "097280ac-668e-4a23-a000-e0da1a3f5db8.4149.1",
                        "bucket_id": "097280ac-668e-4a23-a000-e0da1a3f5db8.4149.1",
                        "tenant": "",
                        "explicit_placement": {
                            "data_pool": "",
                            "data_extra_pool": "",
                            "index_pool": ""
                        }
                    },
                    "key": {
                        "name": "TESTFILE_10MB.bmp.2~nWqoE6c4ONwq1B76_HlcU1UmQZyGXD2.1",
                        "instance": "",
                        "ns": "multipart"
                    }
                },
                "raw_obj": {
                    "pool": "",
                    "oid": "",
                    "loc": ""
                },
                "is_raw": false
            }
        },
        "end_iter": {
            "part_ofs": 0,
            "stripe_ofs": 8388608,
            "ofs": 9684967,
            "stripe_size": 1296359,
            "cur_part_id": 1,
            "cur_stripe": 2,
            "cur_override_prefix": "",
            "location": {
                "placement_rule": "default-placement",
                "obj": {
                    "bucket": {
                        "name": "bucket0",
                        "marker": "097280ac-668e-4a23-a000-e0da1a3f5db8.4149.1",
                        "bucket_id": "097280ac-668e-4a23-a000-e0da1a3f5db8.4149.1",
                        "tenant": "",
                        "explicit_placement": {
                            "data_pool": "",
                            "data_extra_pool": "",
                            "index_pool": ""
                        }
                    },
                    "key": {
                        "name": "TESTFILE_10MB.bmp.2~nWqoE6c4ONwq1B76_HlcU1UmQZyGXD2.1_2",
                        "instance": "",
                        "ns": "shadow"
                    }
                },
                "raw_obj": {
                    "pool": "",
                    "oid": "",
                    "loc": ""
                },
                "is_raw": false
            }
        }
    },
    "attrs": {
        "user.rgw.pg_ver": "",
        "user.rgw.source_zone": "",
        "user.rgw.tail_tag": "097280ac-668e-4a23-a000-e0da1a3f5db8.4147.8",
        "user.rgw.x-amz-content-sha256": "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
        "user.rgw.x-amz-date": "20210725T043616Z"
    }
}

#查看xattrs
[root@k8s build]# ./bin/rados -p default.rgw.buckets.data listxattr 097280ac-668e-4a23-a000-e0da1a3f5db8.4149.1_TESTFILE_10MB.bmp
user.rgw.acl
user.rgw.etag
user.rgw.idtag
user.rgw.manifest
user.rgw.pg_ver
user.rgw.source_zone
user.rgw.tail_tag
user.rgw.x-amz-content-sha256
user.rgw.x-amz-date


```

## 清理分片对象上传垃圾

```shell
while true
do
  rm -f more-to-come
  radosgw-admin bucket list --bucket=pcg-docker |
  grep '"name": "_multipart' |
  awk -F '"' '{print $4}' |
  sed -e 's/^_multipart_//' -e 's/\.meta$//' -e 's/.2~/ 2~/' -e 's/\.[0-9]*$//' |
  sort |
  uniq |
  while read OBJ UPLOADID
  do
    echo "Checking" "s3://pcg-docker/$OBJ" "$UPLOADID"
    if s3cmd listmp "s3://pcg-docker/$OBJ" "$UPLOADID" > /dev/null
    then
      s3cmd abortmp "s3://pcg-docker/$OBJ" "$UPLOADID"
      touch more-to-come
    fi
  done
  if ! [ -f more-to-come ]
  then
    break
  fi
done | tee -a abort-orphan.txt
```

## 



## 参考

http://www.quts.me/2016/07/11/ceph-rgw-multipart/

https://www.codenong.com/cs106288679/

https://blog.csdn.net/weixin_34270606/article/details/92578903

https://www.jianshu.com/p/53071a40afef

https://www.daimajiaoliu.com/daima/4722d3be9100400
