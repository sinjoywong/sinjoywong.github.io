

### 从文件创建configmap

```shell
[root@k8s build]# kubectl create configmap cm-ceph-conf --from-file ceph.conf 
configmap/cm-ceph-conf created
[root@k8s build]# kubectl get configmap
NAME                DATA   AGE
cm-appconfigfiles   1      21h
cm-appvars          2      22h
cm-ceph-conf        1      7s
cm-server.xml       1      21h
[root@k8s build]# kubectl describe configmap cm-ceph-conf
Name:         cm-ceph-conf
Namespace:    default
Labels:       <none>
Annotations:  <none>

Data
====
ceph.conf:
----
; generated by vstart.sh on 2021年 07月 11日 星期日 13:53:30 CST
[client.vstart.sh]
        num mon = 1
        num osd = 1
        num mds = 0
        num mgr = 1
        num rgw = 1
...
Events:  <none>
```

### pod中使用configmap

创建一个pod，volumes中指定configMap为上面定义好的cm-ceph-conf，并作为volumeMounts挂载：

编写配置文件：ceph-conf-test-pod.yaml:

```json
apiVersion: v1
kind: Pod 
metadata:
  name: ceph-conf-test-pod
spec:
  containers:
  - name: ceph-conf-test
    image: busybox
    volumeMounts:
    - name: ceph-conf-volume
      mountPath: /etc/ceph  #注意此处mountPath只能是目录，而不能是文件
    command: [ "/bin/sh", "-ce", "tail -f /dev/null" ]
  volumes:
  - name: ceph-conf-volume
    configMap:
      name: cm-ceph-conf
```

创建pod，进入容器获取挂载位置的配置：

```shell
#创建pod
[root@k8s build]# kubectl create -f ceph-conf-test-pod.yaml 
pod/ceph-conf-test-pod created

[root@k8s build]# kubectl get pods 
NAME                            READY   STATUS      RESTARTS   AGE
centos-test1-64f8887467-lwvdc   1/1     Running     0          2d6h
ceph-conf-test-pod              1/1     Running     0          11s

[root@k8s build]# kubectl describe pod ceph-conf-test-pod
Name:         ceph-conf-test-pod
Namespace:    default
Priority:     0
Node:         k8s/10.206.0.2
Start Time:   Sun, 18 Jul 2021 15:25:57 +0800
Labels:       <none>
Annotations:  cni.projectcalico.org/podIP: 10.244.77.18/32
Status:       Running
IP:           10.244.77.18
IPs:
  IP:  10.244.77.18
Containers:
  ceph-conf-test:
    Container ID:  docker://b1b643d54b1d34674e2c620d89ef95a2e6f12de3d2643c63481e5e39f34d7b95
    Image:         busybox
    Image ID:      docker-pullable://busybox@sha256:0f354ec1728d9ff32edcd7d1b8bbdfc798277ad36120dc3dc683be44524c8b60
    Port:          <none>
    Host Port:     <none>
    Command:
      /bin/sh
      -ce
      tail -f /dev/null
    State:          Running
      Started:      Sun, 18 Jul 2021 15:26:07 +0800
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts: #注意此处
      /etc/ceph from ceph-conf-volume (rw)
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-t87v6 (ro)
Conditions:
  Type              Status
  Initialized       True 
  Ready             True 
  ContainersReady   True 
  PodScheduled      True 
Volumes:
  ceph-conf-volume:
    Type:      ConfigMap (a volume populated by a ConfigMap)
    Name:      cm-ceph-conf
    Optional:  false
  default-token-t87v6:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  default-token-t87v6
    Optional:    false
QoS Class:       BestEffort
Node-Selectors:  <none>
Tolerations:     node.kubernetes.io/not-ready:NoExecute for 300s
                 node.kubernetes.io/unreachable:NoExecute for 300s
Events:
  Type    Reason     Age        From               Message
  ----    ------     ----       ----               -------
  Normal  Scheduled  <unknown>  default-scheduler  Successfully assigned default/ceph-conf-test-pod to k8s
  Normal  Pulling    58s        kubelet, k8s       Pulling image "busybox"
  Normal  Pulled     50s        kubelet, k8s       Successfully pulled image "busybox"
  Normal  Created    50s        kubelet, k8s       Created container ceph-conf-test
  Normal  Started    50s        kubelet, k8s       Started container ceph-conf-test
  
#进入pod确认配置是否能够获取：
[root@k8s build]# kubectl exec -it ceph-conf-test-pod /bin/sh
/ # ls /etc/ceph/
ceph.conf
/ # cat /etc/ceph/ceph.conf 
; generated by vstart.sh on 2021年 07月 11日 星期日 13:53:30 CST
[client.vstart.sh]
        num mon = 1
        num osd = 1
        num mds = 0
        num mgr = 1
        num rgw = 1
...
```



